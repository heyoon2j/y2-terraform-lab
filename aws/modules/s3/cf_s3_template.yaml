---
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  # Application Load Balancer Template
  * For AWS CloudFormation - Application Load Balancer Template
  * You must create alb, after create 'Target Group'.


  ## Resources
  1. ElasticLoadBalancingV2::LoadBalancer

  ## Parameter


Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Bucket Configuration"
        Parameters:
          - BucketNameParam
          - BucketKeyEnabledParam
          - KeyIDParam
#          - PolicyDocumentParam


#Mappings:



Parameters:
  BucketNameParam:
    Description: 'Bucket Name'
    Type: String
    Default: "s3-y2j-cf-test12"
  BucketKeyEnabledParam:
    Description: 'Server-side encryption using KMS : true, false (Default: false)
    Type: String
    Default: "false"
    AllowedValues:
      - 'false'
      - 'true'
  KeyIDParam:
    Description: 'KMS Key ID'
    Type: String
    Default: "null"
#  PolicyDocumentParam:
#    Description: ''
#    Type: String
   

#Rules:


Conditions:
  IsEncrypted: !Not [!Equals [!Ref BucketKeyEnabledParam, "null"]]
  UsesKMS: !Not [!Equals [!Ref KeyIDParam, "null"]]  


Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties: 
      BucketName: !Ref BucketNameParam

      # Security
      BucketEncryption: 
        ServerSideEncryptionConfiguration: 
          - BucketKeyEnabled: !Ref BucketKeyEnabledParam
            ServerSideEncryptionByDefault:
                KMSMasterKeyID: !If [IsEncrypted, !Ref KeyIDParam, !Ref AWS::NoValue]
                SSEAlgorithm: !If [IsEncrypted, !If [UsesKMS, "aws:kms", AES256"], !Ref AWS::NoValue]

      PublicAccessBlockConfiguration: 
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true

      OwnershipControls: 
        Rules: # BucketOwnerEnforced| ObjectWriter| BucketOwnerPreferred
          - OwnershipControlsRule: BucketOwnerEnforced

#      AccessControl: String
#      CorsConfiguration: 
#        CorsConfiguration      


      # Object Management
      VersioningConfiguration: 
          Status: Suspended
      
      ObjectLockEnabled: false
#      ObjectLockConfiguration: 
#        ObjectLockConfiguration
      


      # Bucket Management
#      LifecycleConfiguration: 
#        LifecycleConfiguration

#      LoggingConfiguration: 
#        DestinationBucketName: String
#        LogFilePrefix: String

#      MetricsConfigurations: 
#        - MetricsConfiguration


      Tags:
        - Key: CloudFormationStack
          Value: !Ref 'AWS::StackId'
        - Key: Name
          Value: !Ref BucketNameParam


################## Not Use ##################
#      NotificationConfiguration: 
#        NotificationConfiguration

#      AnalyticsConfigurations: 
#        - AnalyticsConfiguration

#      IntelligentTieringConfigurations: 
#        - IntelligentTieringConfiguration
      
#      InventoryConfigurations: 
#        - InventoryConfiguration

#     ReplicationConfiguration: 
#        ReplicationConfiguration


      # Other

      # Transfer Accelerate for Edge Location (AWS CloudFront)
#      AccelerateConfiguration: 
#        AccelerationStatus: Suspended   # Enabled | Suspended

      # Web Service
#      WebsiteConfiguration: 
#        WebsiteConfiguration



  S3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties: 
      Bucket: !Ref BucketNameParam
      PolicyDocument: ''
#        Version: 2012-10-17
#        Statement:
#          - Action:
#              - 's3:GetObject'
#            Effect: Allow
#            Resource: !Join
#              - ''
#              - - 'arn:aws:s3:::'
#                - !Ref DOC-EXAMPLE-BUCKET
#                - /*
#            Principal: '*'
#            Condition:
#              StringLike:
#                'aws:Referer':
#                  - 'http://www.example.com/*'
#                  - 'http://example.net/*'



Outputs:
  S3ARN:
    Description: S3 Bucket ID
    Value: !Ref S3Bucket
    Export:
      Name: !Sub "${AWS::StackName}-BucketArn"
...
